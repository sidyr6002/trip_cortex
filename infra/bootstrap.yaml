AWSTemplateFormatVersion: '2010-09-09'
Description: >
  Bootstrap stack â€” GitHub Actions OIDC provider and deploy role.
  Deploy once per account: aws cloudformation deploy --template-file infra/bootstrap.yaml --stack-name trip-cortex-bootstrap --capabilities CAPABILITY_NAMED_IAM

Parameters:
  GitHubOrg:
    Type: String
    Default: sidyr6002
  GitHubRepo:
    Type: String
    Default: trip_cortex

Resources:

  GitHubOIDCProvider:
    Type: AWS::IAM::OIDCProvider
    Properties:
      Url: https://token.actions.githubusercontent.com
      ClientIdList: [sts.amazonaws.com]
      ThumbprintList: [6938fd4d98bab03faadb97b34396831e3780aea1]

  DeployRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: trip-cortex-github-actions-dev
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Federated: !GetAtt GitHubOIDCProvider.Arn
            Action: sts:AssumeRoleWithWebIdentity
            Condition:
              StringEquals:
                token.actions.githubusercontent.com:aud: sts.amazonaws.com
              StringLike:
                token.actions.githubusercontent.com:sub: !Sub "repo:${GitHubOrg}/${GitHubRepo}:*"
      Policies:
        - PolicyName: trip-cortex-deploy-policy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Sid: CloudFormationFull
                Effect: Allow
                Action: cloudformation:*
                Resource:
                  - !Sub "arn:aws:cloudformation:${AWS::Region}:${AWS::AccountId}:stack/trip-cortex-*/*"
                  - !Sub "arn:aws:cloudformation:${AWS::Region}:${AWS::AccountId}:stack/aws-sam-cli-managed-default/*"
              - Sid: CloudFormationGlobal
                Effect: Allow
                Action:
                  - cloudformation:CreateChangeSet
                  - cloudformation:ListStacks
                  - cloudformation:ValidateTemplate
                  - cloudformation:GetTemplateSummary
                Resource: "*"
              - Sid: CloudFormationTransform
                Effect: Allow
                Action: cloudformation:CreateChangeSet
                Resource: !Sub "arn:aws:cloudformation:${AWS::Region}:aws:transform/*"
              - Sid: S3DeployBucket
                Effect: Allow
                Action:
                  - s3:CreateBucket
                  - s3:GetObject
                  - s3:PutObject
                  - s3:DeleteObject
                  - s3:ListBucket
                  - s3:GetBucketLocation
                  - s3:PutBucketPolicy
                  - s3:PutBucketTagging
                  - s3:PutBucketVersioning
                  - s3:PutEncryptionConfiguration
                  - s3:PutLifecycleConfiguration
                  - s3:GetBucketPolicy
                  - s3:GetEncryptionConfiguration
                  - s3:GetLifecycleConfiguration
                  - s3:PutBucketPublicAccessBlock
                  - s3:GetBucketPublicAccessBlock
                  - s3:GetBucketVersioning
                  - s3:GetBucketTagging
                Resource:
                  - "arn:aws:s3:::trip-cortex-*"
                  - "arn:aws:s3:::trip-cortex-*/*"
                  - "arn:aws:s3:::aws-sam-cli-managed-*"
                  - "arn:aws:s3:::aws-sam-cli-managed-*/*"
              - Sid: LambdaManagement
                Effect: Allow
                Action: lambda:*
                Resource: !Sub "arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:trip-cortex-*"
              - Sid: IAMRoles
                Effect: Allow
                Action:
                  - iam:PassRole
                  - iam:GetRole
                  - iam:CreateRole
                  - iam:DeleteRole
                  - iam:AttachRolePolicy
                  - iam:DetachRolePolicy
                  - iam:PutRolePolicy
                  - iam:DeleteRolePolicy
                  - iam:GetRolePolicy
                  - iam:TagRole
                  - iam:UntagRole
                Resource: !Sub "arn:aws:iam::${AWS::AccountId}:role/trip-cortex-*"
              - Sid: APIGateway
                Effect: Allow
                Action: apigateway:*
                Resource: !Sub "arn:aws:apigateway:${AWS::Region}::/*"
              - Sid: DynamoDB
                Effect: Allow
                Action: dynamodb:*
                Resource: !Sub "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/trip-cortex-*"
              - Sid: StepFunctions
                Effect: Allow
                Action: states:*
                Resource: !Sub "arn:aws:states:${AWS::Region}:${AWS::AccountId}:stateMachine:trip-cortex-*"
              - Sid: SecretsManagerRead
                Effect: Allow
                Action:
                  - secretsmanager:GetSecretValue
                  - secretsmanager:DescribeSecret
                Resource: !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:trip-cortex/*"
              - Sid: RDSAurora
                Effect: Allow
                Action: rds:*
                Resource:
                  - !Sub "arn:aws:rds:${AWS::Region}:${AWS::AccountId}:cluster:trip-cortex-*"
                  - !Sub "arn:aws:rds:${AWS::Region}:${AWS::AccountId}:db:trip-cortex-*"
                  - !Sub "arn:aws:rds:${AWS::Region}:${AWS::AccountId}:subgrp:trip-cortex-*"
              - Sid: EC2Networking
                Effect: Allow
                Action:
                  - ec2:Describe*
                  - ec2:CreateVpc
                  - ec2:CreateSubnet
                  - ec2:CreateSecurityGroup
                  - ec2:CreateRouteTable
                  - ec2:CreateInternetGateway
                  - ec2:CreateNatGateway
                  - ec2:CreateVpcEndpoint
                  - ec2:CreateRoute
                  - ec2:CreateTags
                  - ec2:DeleteVpc
                  - ec2:DeleteSubnet
                  - ec2:DeleteSecurityGroup
                  - ec2:DeleteRouteTable
                  - ec2:DeleteInternetGateway
                  - ec2:DeleteNatGateway
                  - ec2:DeleteVpcEndpoint
                  - ec2:DeleteRoute
                  - ec2:ModifyVpcAttribute
                  - ec2:ModifySubnetAttribute
                  - ec2:AttachInternetGateway
                  - ec2:DetachInternetGateway
                  - ec2:AssociateRouteTable
                  - ec2:DisassociateRouteTable
                  - ec2:AllocateAddress
                  - ec2:ReleaseAddress
                  - ec2:AuthorizeSecurityGroupIngress
                  - ec2:AuthorizeSecurityGroupEgress
                  - ec2:RevokeSecurityGroupIngress
                  - ec2:RevokeSecurityGroupEgress
                Resource: "*"
              - Sid: EventBridge
                Effect: Allow
                Action: events:*
                Resource: !Sub "arn:aws:events:${AWS::Region}:${AWS::AccountId}:rule/trip-cortex-*"

Outputs:
  DeployRoleArn:
    Description: Set this as AWS_ROLE_ARN_DEV in GitHub Secrets
    Value: !GetAtt DeployRole.Arn
